<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>School Fees Management System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf-autotable.min.js"></script>
    <style>
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        
        @media print {
            @page { margin: 0; size: A4; }
            body { background: white !important; -webkit-print-color-adjust: exact; }
            .no-print { display: none !important; }
            #receipt-container { 
                display: block !important; 
                visibility: visible !important;
                position: absolute; 
                top: 0; left: 0; width: 100%;
                background: white !important;
                padding: 20px;
                z-index: 9999;
            }
            main, aside, #toast, .modal, .tab-content { display: none !important; }
        }

        .active-nav { background: #eff6ff; border-left: 4px solid #3b82f6; color: #1e40af; }
        .paid-stamp {
            border: 4px solid #059669;
            color: #059669;
            padding: 4px 12px;
            font-size: 24px;
            font-weight: bold;
            text-transform: uppercase;
            transform: rotate(-15deg);
            display: inline-block;
            opacity: 0.7;
            border-radius: 8px;
        }
        .dashboard-card { transition: transform 0.2s; cursor: default; }
        .dashboard-card:hover { transform: translateY(-5px); }
        
        /* Modal for Receipt to prevent UI shift */
        #receipt-container:not(.hidden) {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.8);
            z-index: 100;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 40px 0;
        }
    </style>
</head>
<body class="bg-slate-50 font-sans text-slate-900 overflow-hidden">
    <div class="flex h-screen overflow-hidden">
        <!-- Sidebar -->
        <aside class="w-64 bg-white border-r flex flex-col no-print">
            <div class="p-6 border-b flex items-center gap-3">
                <div id="sidebar-logo" class="w-10 h-10 bg-blue-600 rounded-xl flex items-center justify-center text-white overflow-hidden shadow-lg">
                    <i class="ph-fill ph-student-house text-2xl"></i>
                </div>
                <h1 id="sidebar-school-name" class="font-bold text-lg tracking-tight">SmartSchool</h1>
            </div>

            <nav class="flex-1 p-4 space-y-2 overflow-y-auto">
                <button onclick="switchTab('dashboard')" id="nav-dashboard" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all hover:bg-slate-50">
                    <i class="ph-bold ph-squares-four text-xl"></i> Dashboard
                </button>
                <button onclick="switchTab('students')" id="nav-students" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all hover:bg-slate-50">
                    <i class="ph-bold ph-users text-xl"></i> Students
                </button>
                <button onclick="switchTab('ledger')" id="nav-ledger" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all hover:bg-slate-50">
                    <i class="ph-bold ph-notebook text-xl"></i> Fees Ledger
                </button>
                <button onclick="switchTab('payment')" id="nav-payment" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all hover:bg-slate-50">
                    <i class="ph-bold ph-receipt text-xl"></i> Collect Fees
                </button>
                <button onclick="switchTab('reports')" id="nav-reports" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all hover:bg-slate-50">
                    <i class="ph-bold ph-chart-line-up text-xl"></i> Reports
                </button>
                <button onclick="checkAdminAccess('settings')" id="nav-settings" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all hover:bg-slate-50">
                    <i class="ph-bold ph-gear text-xl"></i> School Settings
                </button>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 overflow-y-auto p-8 relative no-print">
            
            <!-- Dashboard -->
            <section id="tab-dashboard" class="tab-content">
                <header class="mb-8">
                    <h2 class="text-3xl font-bold">Financial Overview</h2>
                    <p class="text-slate-500">Live statistics from your fees database.</p>
                </header>
                
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="dashboard-card bg-white p-6 rounded-3xl border border-slate-100 shadow-sm flex flex-col justify-between">
                        <div class="flex justify-between items-start mb-4">
                            <div class="w-12 h-12 bg-blue-50 text-blue-600 rounded-2xl flex items-center justify-center"><i class="ph-fill ph-users-three text-2xl"></i></div>
                            <span class="text-blue-500 bg-blue-50 px-2 py-1 rounded-lg text-xs font-bold">Active</span>
                        </div>
                        <div>
                            <p class="text-slate-500 text-sm font-medium">Total Students</p>
                            <h3 class="text-3xl font-bold mt-1" id="dash-total-students">0</h3>
                        </div>
                    </div>

                    <div class="dashboard-card bg-white p-6 rounded-3xl border border-slate-100 shadow-sm flex flex-col justify-between">
                        <div class="flex justify-between items-start mb-4">
                            <div class="w-12 h-12 bg-emerald-50 text-emerald-600 rounded-2xl flex items-center justify-center"><i class="ph-fill ph-hand-coins text-2xl"></i></div>
                            <span class="text-emerald-500 bg-emerald-50 px-2 py-1 rounded-lg text-xs font-bold">Collected</span>
                        </div>
                        <div>
                            <p class="text-slate-500 text-sm font-medium">Fees Collected</p>
                            <h3 class="text-3xl font-bold mt-1 text-emerald-600" id="dash-total-collected">Rs 0</h3>
                        </div>
                    </div>

                    <div class="dashboard-card bg-white p-6 rounded-3xl border border-slate-100 shadow-sm flex flex-col justify-between">
                        <div class="flex justify-between items-start mb-4">
                            <div class="w-12 h-12 bg-rose-50 text-rose-600 rounded-2xl flex items-center justify-center"><i class="ph-fill ph-warning-circle text-2xl"></i></div>
                            <span class="text-rose-500 bg-rose-50 px-2 py-1 rounded-lg text-xs font-bold">Pending</span>
                        </div>
                        <div>
                            <p class="text-slate-500 text-sm font-medium">Outstanding Dues</p>
                            <h3 class="text-3xl font-bold mt-1 text-rose-600" id="dash-total-dues">Rs 0</h3>
                        </div>
                    </div>

                    <div class="dashboard-card bg-white p-6 rounded-3xl border border-slate-100 shadow-sm flex flex-col justify-between">
                        <div class="flex justify-between items-start mb-4">
                            <div class="w-12 h-12 bg-indigo-50 text-indigo-600 rounded-2xl flex items-center justify-center"><i class="ph-fill ph-bank text-2xl"></i></div>
                            <span class="text-indigo-500 bg-indigo-50 px-2 py-1 rounded-lg text-xs font-bold">Forecast</span>
                        </div>
                        <div>
                            <p class="text-slate-500 text-sm font-medium">Total Receivable</p>
                            <h3 class="text-3xl font-bold mt-1" id="dash-total-receivable">Rs 0</h3>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                    <!-- Previous 6 Months Analysis -->
                    <div class="bg-white p-8 rounded-[2rem] border shadow-sm">
                        <h4 class="font-bold mb-6 flex items-center gap-2 text-slate-800"><i class="ph-bold ph-calendar text-blue-600"></i> Last 6 Months Collection</h4>
                        <div class="space-y-4" id="monthly-analysis-list">
                            <!-- JS will inject here -->
                        </div>
                    </div>

                    <div class="bg-white p-8 rounded-[2rem] border shadow-sm">
                        <h4 class="font-bold mb-4 flex items-center gap-2"><i class="ph ph-trend-up text-blue-600"></i> Quick Actions</h4>
                        <div class="flex flex-col gap-4">
                            <button onclick="switchTab('payment')" class="w-full p-4 border rounded-2xl hover:bg-blue-50 hover:border-blue-200 transition-all text-left flex items-center gap-4">
                                <div class="w-12 h-12 bg-blue-100 rounded-xl flex items-center justify-center text-blue-600"><i class="ph-bold ph-receipt text-2xl"></i></div>
                                <div>
                                    <p class="font-bold">Collect New Fee</p>
                                    <p class="text-xs text-slate-500">Quickly process a student payment</p>
                                </div>
                            </button>
                            <button onclick="switchTab('reports')" class="w-full p-4 border rounded-2xl hover:bg-rose-50 hover:border-rose-200 transition-all text-left flex items-center gap-4">
                                <div class="w-12 h-12 bg-rose-100 rounded-xl flex items-center justify-center text-rose-600"><i class="ph-bold ph-file-pdf"></i></div>
                                <div>
                                    <p class="font-bold">Generate Defaulters List</p>
                                    <p class="text-xs text-slate-500">Export unpaid student details</p>
                                </div>
                            </button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Students Section -->
            <section id="tab-students" class="tab-content hidden">
                <header class="flex justify-between items-center mb-8">
                    <div><h2 class="text-3xl font-bold">Students</h2></div>
                    <div class="flex gap-2">
                        <label class="bg-emerald-600 text-white px-4 py-2 rounded-xl cursor-pointer hover:bg-emerald-700 flex items-center gap-2 shadow-sm">
                            <i class="ph-bold ph-file-arrow-up"></i> Upload CSV
                            <input type="file" id="csv-upload" accept=".csv" class="hidden" onchange="handleFileUpload(event)">
                        </label>
                        <button onclick="toggleModal('student-modal')" class="bg-blue-600 text-white px-4 py-2 rounded-xl flex items-center gap-2 shadow-lg hover:bg-blue-700"><i class="ph-bold ph-plus"></i> Add Student</button>
                    </div>
                </header>
                <div class="bg-white rounded-3xl border overflow-hidden shadow-sm">
                    <table class="w-full text-left">
                        <thead class="bg-slate-50 text-xs uppercase text-slate-500">
                            <tr><th class="px-6 py-4">ID</th><th class="px-6 py-4">Name</th><th class="px-6 py-4">Father</th><th class="px-6 py-4">Class</th><th class="px-6 py-4">Monthly Fee</th><th class="px-6 py-4">Actions</th></tr>
                        </thead>
                        <tbody id="student-table-body" class="divide-y divide-slate-100"></tbody>
                    </table>
                </div>
            </section>

            <!-- Ledger Section -->
            <section id="tab-ledger" class="tab-content hidden">
                <header class="mb-8"><h2 class="text-3xl font-bold">Fees Ledger</h2></header>
                <div class="bg-white rounded-3xl border overflow-hidden shadow-sm">
                    <table class="w-full text-left">
                        <thead class="bg-slate-50 text-xs uppercase text-slate-500">
                            <tr>
                                <th class="px-6 py-4">Student</th>
                                <th class="px-6 py-4">Father</th>
                                <th class="px-6 py-4">Class</th>
                                <th class="px-6 py-4">Payable</th>
                                <th class="px-6 py-4">Paid</th>
                                <th class="px-6 py-4">Balance</th>
                                <th class="px-6 py-4 text-center">Status</th>
                            </tr>
                        </thead>
                        <tbody id="ledger-table-body" class="divide-y divide-slate-100"></tbody>
                        <tfoot class="bg-slate-50 font-bold">
                            <tr>
                                <td colspan="3" class="px-6 py-4 text-right">Total Aggregate:</td>
                                <td class="px-6 py-4" id="total-payable-sum">Rs 0</td>
                                <td class="px-6 py-4 text-emerald-600" id="total-paid-sum">Rs 0</td>
                                <td class="px-6 py-4 text-rose-600" id="total-balance-sum">Rs 0</td>
                                <td></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </section>

            <!-- Payment Section -->
            <section id="tab-payment" class="tab-content hidden">
                <div class="max-w-xl mx-auto bg-white p-10 rounded-[3rem] border shadow-xl">
                    <h2 class="text-2xl font-bold mb-6 text-center">Collect Fee</h2>
                    <form id="payment-form" class="space-y-4">
                        <div>
                            <label class="block text-sm font-semibold mb-1">Student (Showing only with Dues)</label>
                            <select id="pay-student-id" required onchange="handleStudentSelect()" class="w-full p-4 bg-slate-50 border rounded-2xl outline-none ring-offset-2 focus:ring-2 focus:ring-blue-500">
                                <option value="">Select Student...</option>
                            </select>
                        </div>
                        <div id="payment-details-box" class="hidden space-y-4">
                            <div class="bg-rose-50 p-4 rounded-2xl border border-rose-100 flex justify-between items-center">
                                <div>
                                    <p class="text-rose-600 text-xs font-bold uppercase">Outstanding Balance</p>
                                    <p class="text-2xl font-bold text-rose-700" id="pay-outstanding">Rs 0</p>
                                </div>
                                <i class="ph ph-receipt text-3xl text-rose-300"></i>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-semibold mb-1">Fee Month</label>
                                    <input type="month" id="pay-month" required class="w-full p-4 bg-slate-50 border rounded-2xl">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold mb-1">Payment Amount</label>
                                    <input type="number" id="pay-amount" required class="w-full p-4 bg-slate-100 border rounded-2xl font-bold text-xl">
                                </div>
                            </div>
                            <button type="submit" class="w-full bg-slate-900 text-white py-4 rounded-2xl font-bold hover:bg-black transition-all shadow-lg active:scale-95">Process & Generate Receipt</button>
                        </div>
                    </form>
                </div>
            </section>

            <!-- Reports Section -->
            <section id="tab-reports" class="tab-content hidden">
                <header class="flex justify-between items-center mb-8">
                    <h2 class="text-3xl font-bold">Reports Center</h2>
                    <div class="flex gap-2">
                        <select id="report-class-filter" onchange="renderReports()" class="px-4 py-2 border rounded-xl bg-white shadow-sm">
                            <option value="">All Classes</option>
                            <option>Grade 1</option><option>Grade 2</option><option>Grade 3</option><option>Grade 4</option><option>Grade 5</option>
                            <option>Grade 6</option><option>Grade 7</option><option>Grade 8</option><option>Grade 9</option><option>Grade 10</option>
                        </select>
                        <button onclick="exportToPDF()" class="bg-rose-600 text-white px-4 py-2 rounded-xl flex items-center gap-2 shadow-lg hover:bg-rose-700">
                            <i class="ph-bold ph-file-pdf"></i> Export to PDF
                        </button>
                    </div>
                </header>
                <div class="bg-white rounded-3xl border overflow-hidden shadow-sm">
                    <table class="w-full text-left" id="report-table">
                        <thead class="bg-slate-50 text-xs uppercase text-slate-500">
                            <tr>
                                <th class="px-6 py-4">Student Name</th>
                                <th class="px-6 py-4">Father Name</th>
                                <th class="px-6 py-4">Class</th>
                                <th class="px-6 py-4">Outstanding Balance</th>
                            </tr>
                        </thead>
                        <tbody id="report-table-body" class="divide-y divide-slate-100"></tbody>
                        <tfoot class="bg-slate-50 font-bold">
                            <tr>
                                <td colspan="3" class="px-6 py-4 text-right">Total Defaulter Sum:</td>
                                <td class="px-6 py-4 text-rose-600" id="report-total-sum">Rs 0</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </section>

            <!-- Settings -->
            <section id="tab-settings" class="tab-content hidden">
                <header class="mb-8"><h2 class="text-3xl font-bold">School Settings</h2></header>
                <div class="max-w-2xl bg-white p-8 rounded-3xl border shadow-sm space-y-6">
                    <div class="grid grid-cols-2 gap-4">
                        <div class="col-span-2">
                            <label class="block text-sm font-semibold mb-1">School Name</label>
                            <input type="text" id="set-school-name" class="w-full p-3 bg-slate-50 border rounded-xl">
                        </div>
                        <div class="col-span-2">
                            <label class="block text-sm font-semibold mb-1">Address</label>
                            <input type="text" id="set-address" class="w-full p-3 bg-slate-50 border rounded-xl">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold mb-1">Contact No.</label>
                            <input type="text" id="set-contact" class="w-full p-3 bg-slate-50 border rounded-xl">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold mb-1">Upload School Logo</label>
                            <input type="file" id="set-logo-input" accept="image/*" class="w-full p-2 bg-slate-50 border rounded-xl text-sm" onchange="handleLogoUpload(this)">
                        </div>
                    </div>
                    <div id="logo-preview-container" class="border-t pt-4 flex items-center gap-4">
                         <div id="logo-preview" class="w-16 h-16 border rounded-lg bg-slate-100 flex items-center justify-center overflow-hidden">
                             <i class="ph ph-image text-slate-300"></i>
                         </div>
                         <p class="text-xs text-slate-400">Preview of currently saved logo.</p>
                    </div>
                    <button onclick="saveSettings()" class="bg-blue-600 text-white px-6 py-3 rounded-xl font-bold shadow-lg hover:bg-blue-700">Update Profile</button>
                </div>
            </section>
        </main>

        <!-- Receipt Template -->
        <div id="receipt-container" class="hidden no-print">
            <div class="receipt-box border-2 border-black p-4 mb-8 relative bg-white w-[700px] shadow-2xl">
                <div class="flex justify-between items-start border-b-2 border-dashed pb-4 mb-4">
                    <div class="flex items-center gap-4">
                        <div class="r-logo-wrap w-16 h-16 border-2 border-slate-900 rounded flex items-center justify-center overflow-hidden">
                             <img class="r-logo w-full h-full object-contain" src="">
                        </div>
                        <div>
                            <h2 class="text-2xl font-black uppercase r-school-name">SMARTSCHOOL</h2>
                            <p class="text-[12px] r-school-address"></p>
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="font-bold border-2 border-black px-4 py-1 text-sm bg-black text-white">STUDENT COPY</p>
                        <p class="text-sm mt-1">Date: <span class="r-date"></span></p>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-y-3 text-sm mb-6 border-b pb-4">
                    <p><strong>Student Name:</strong> <span class="r-name"></span></p>
                    <p><strong>Father's Name:</strong> <span class="r-father"></span></p>
                    <p><strong>Class:</strong> <span class="r-class"></span></p>
                    <p><strong>Billing Month:</strong> <span class="r-month"></span></p>
                </div>
                <div class="bg-slate-100 p-4 rounded-lg flex justify-between items-center mb-8 border border-slate-200">
                    <div class="space-y-1">
                        <p class="text-sm">Total Payable: <span class="r-payable"></span></p>
                        <p class="text-xl font-black">Paid Amount: <span class="r-paid"></span></p>
                        <p class="text-sm">Current Balance: <span class="r-bal"></span></p>
                    </div>
                    <div class="paid-stamp">PAID</div>
                </div>
                <div class="mt-12 flex justify-between items-end">
                    <p class="text-[10px] text-slate-400">System Generated | SmartSchool Fees Manager</p>
                    <div class="text-center border-t-2 border-black w-48 text-sm pt-1 font-bold">Signature of Accountant</div>
                </div>
            </div>
            
            <div class="receipt-box border-2 border-black p-4 relative bg-white w-[700px] shadow-2xl">
                <div class="flex justify-between items-start border-b-2 border-dashed pb-4 mb-4">
                    <div class="flex items-center gap-4">
                        <div class="r-logo-wrap w-16 h-16 border-2 border-slate-900 rounded flex items-center justify-center overflow-hidden">
                             <img class="r-logo w-full h-full object-contain" src="">
                        </div>
                        <div>
                            <h2 class="text-2xl font-black uppercase r-school-name">SMARTSCHOOL</h2>
                            <p class="text-[12px] r-school-address"></p>
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="font-bold border-2 border-black px-4 py-1 text-sm bg-black text-white">OFFICE COPY</p>
                        <p class="text-sm mt-1">Date: <span class="r-date"></span></p>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-y-3 text-sm mb-6 border-b pb-4">
                    <p><strong>Student Name:</strong> <span class="r-name"></span></p>
                    <p><strong>Father's Name:</strong> <span class="r-father"></span></p>
                    <p><strong>Class:</strong> <span class="r-class"></span></p>
                    <p><strong>Billing Month:</strong> <span class="r-month"></span></p>
                </div>
                <div class="bg-slate-100 p-4 rounded-lg flex justify-between items-center mb-8 border border-slate-200">
                    <div class="space-y-1">
                        <p class="text-sm">Total Payable: <span class="r-payable"></span></p>
                        <p class="text-xl font-black">Paid Amount: <span class="r-paid"></span></p>
                        <p class="text-sm">Current Balance: <span class="r-bal"></span></p>
                    </div>
                    <div class="paid-stamp">PAID</div>
                </div>
                <div class="mt-12 flex justify-between items-end">
                    <p class="text-[10px] text-slate-400">System Generated | SmartSchool Fees Manager</p>
                    <div class="text-center border-t-2 border-black w-48 text-sm pt-1 font-bold">Signature of Accountant</div>
                </div>
            </div>
            <div class="mt-8 flex justify-center no-print">
                <button onclick="document.getElementById('receipt-container').classList.add('hidden')" class="bg-blue-600 text-white px-10 py-3 rounded-full font-bold shadow-xl">Close Receipt View</button>
            </div>
        </div>
    </div>

    <!-- Student Modal -->
    <div id="student-modal" class="fixed inset-0 bg-black/50 hidden z-50 flex items-center justify-center">
        <div class="bg-white rounded-[2.5rem] w-full max-w-md p-8 shadow-2xl scale-95 transition-transform">
            <h3 class="text-2xl font-bold mb-6">Student Information</h3>
            <form id="student-form" class="space-y-4">
                <input type="hidden" id="edit-id">
                <div class="space-y-1">
                    <label class="text-xs font-bold text-slate-500 uppercase ml-2">Full Name</label>
                    <input type="text" id="st-name" required class="w-full p-4 bg-slate-50 border rounded-2xl outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="space-y-1">
                    <label class="text-xs font-bold text-slate-500 uppercase ml-2">Father's Name</label>
                    <input type="text" id="st-father" required class="w-full p-4 bg-slate-50 border rounded-2xl outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="space-y-1">
                    <label class="text-xs font-bold text-slate-500 uppercase ml-2">Assigned Class</label>
                    <select id="st-class" class="w-full p-4 bg-slate-50 border rounded-2xl">
                        <option>Grade 1</option><option>Grade 2</option><option>Grade 3</option><option>Grade 4</option><option>Grade 5</option>
                        <option>Grade 6</option><option>Grade 7</option><option>Grade 8</option><option>Grade 9</option><option>Grade 10</option>
                    </select>
                </div>
                <div class="space-y-1">
                    <label class="text-xs font-bold text-slate-500 uppercase ml-2">Monthly Fee (Rs)</label>
                    <input type="number" id="st-fee" required class="w-full p-4 bg-slate-50 border rounded-2xl">
                </div>
                <div class="pt-4 space-y-2">
                    <button type="submit" class="w-full bg-blue-600 text-white py-4 rounded-2xl font-bold shadow-lg">Save Student Profile</button>
                    <button type="button" onclick="toggleModal('student-modal')" class="w-full text-slate-400 py-2">Discard Changes</button>
                </div>
            </form>
        </div>
    </div>

    <div id="toast" class="fixed bottom-8 left-1/2 -translate-x-1/2 bg-slate-900 text-white px-8 py-3 rounded-2xl shadow-2xl opacity-0 transition-all z-[100] pointer-events-none">Message</div>

    <script>
        const DB = {
            init() {
                if(!localStorage.getItem('ss_students')) localStorage.setItem('ss_students', '[]');
                if(!localStorage.getItem('ss_ledger')) localStorage.setItem('ss_ledger', '[]');
                if(!localStorage.getItem('ss_transactions')) localStorage.setItem('ss_transactions', '[]');
                if(!localStorage.getItem('ss_settings')) localStorage.setItem('ss_settings', JSON.stringify({
                    name: "SmartSchool",
                    address: "Main Campus, City Education Complex",
                    contact: "+92 300 0000000",
                    logo: ""
                }));
            },
            getStudents: () => JSON.parse(localStorage.getItem('ss_students')),
            getLedger: () => JSON.parse(localStorage.getItem('ss_ledger')),
            getTransactions: () => JSON.parse(localStorage.getItem('ss_transactions')),
            getSettings: () => JSON.parse(localStorage.getItem('ss_settings')),
            
            saveStudent(st) {
                const data = this.getStudents();
                const isDuplicate = data.some(s => 
                    s.name.toLowerCase().trim() === st.name.toLowerCase().trim() && 
                    s.fatherName.toLowerCase().trim() === st.fatherName.toLowerCase().trim() &&
                    s.id !== st.id
                );

                if(isDuplicate) {
                    showToast("Duplicate Detected! Student already exists.");
                    return false;
                }

                if(st.id) {
                    const idx = data.findIndex(s => s.id === st.id);
                    data[idx] = st;
                } else {
                    st.id = 'ST' + Math.floor(Math.random() * 900000 + 100000);
                    st.status = 'Active';
                    data.push(st);
                    
                    const ledger = this.getLedger();
                    const currentMonth = new Date().toISOString().slice(0, 7);
                    ledger.push({
                        studentId: st.id,
                        month: currentMonth,
                        payable: parseFloat(st.fee),
                        paid: 0,
                        balance: parseFloat(st.fee)
                    });
                    localStorage.setItem('ss_ledger', JSON.stringify(ledger));
                }
                localStorage.setItem('ss_students', JSON.stringify(data));
                this.updateUI();
                return true;
            },
            
            updateUI() {
                renderDashboard();
                renderStudents();
                renderLedger();
                initPaymentForm();
                renderReports();
                applySettings();
            }
        };

        function switchTab(tab) {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
            document.querySelectorAll('aside button').forEach(b => b.classList.remove('active-nav'));
            document.getElementById('tab-' + tab).classList.remove('hidden');
            document.getElementById('nav-' + tab).classList.add('active-nav');
        }

        function checkAdminAccess(tab) {
            const pass = prompt("Enter School Admin/Developer Code:");
            if (pass === "admin123") switchTab(tab);
            else showToast("Access Restricted!");
        }

        function toggleModal(id) {
            document.getElementById(id).classList.toggle('hidden');
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.classList.remove('opacity-0');
            t.classList.add('translate-y-[-20px]');
            setTimeout(() => {
                t.classList.add('opacity-0');
                t.classList.remove('translate-y-[-20px]');
            }, 3000);
        }

        function renderStudents() {
            const tbody = document.getElementById('student-table-body');
            tbody.innerHTML = DB.getStudents().map(s => `
                <tr class="hover:bg-slate-50 transition-colors">
                    <td class="px-6 py-4 text-xs font-mono text-slate-400">${s.id}</td>
                    <td class="px-6 py-4 font-bold text-slate-700">${s.name}</td>
                    <td class="px-6 py-4 text-slate-500">${s.fatherName}</td>
                    <td class="px-6 py-4"><span class="bg-blue-50 text-blue-600 px-3 py-1 rounded-full text-[10px] font-black uppercase">${s.class}</span></td>
                    <td class="px-6 py-4 font-bold">Rs ${s.fee}</td>
                    <td class="px-6 py-4 flex gap-3">
                        <button onclick="editStudent('${s.id}')" class="text-blue-600"><i class="ph-bold ph-pencil"></i></button>
                        <button onclick="deleteStudent('${s.id}')" class="text-rose-600"><i class="ph-bold ph-trash"></i></button>
                    </td>
                </tr>
            `).join('');
        }

        function editStudent(id) {
            const st = DB.getStudents().find(s => s.id === id);
            document.getElementById('edit-id').value = st.id;
            document.getElementById('st-name').value = st.name;
            document.getElementById('st-father').value = st.fatherName;
            document.getElementById('st-class').value = st.class;
            document.getElementById('st-fee').value = st.fee;
            toggleModal('student-modal');
        }

        function deleteStudent(id) {
            if(confirm("Delete student and records?")) {
                const data = DB.getStudents().filter(s => s.id !== id);
                localStorage.setItem('ss_students', JSON.stringify(data));
                DB.updateUI();
            }
        }

        function handleFileUpload(event) {
            const file = event.target.files[0];
            const reader = new FileReader();
            reader.onload = function(e) {
                const rows = e.target.result.split('\n').slice(1);
                let count = 0;
                rows.forEach(row => {
                    const cols = row.split(',');
                    if(cols.length >= 4) {
                        const success = DB.saveStudent({
                            name: cols[0].trim(), fatherName: cols[1].trim(), class: cols[2].trim(), fee: cols[3].trim()
                        });
                        if(success) count++;
                    }
                });
                showToast(`${count} Students Imported`);
                event.target.value = '';
            };
            reader.readAsText(file);
        }

        function renderLedger() {
            const sts = DB.getStudents();
            const ledger = DB.getLedger();
            const tbody = document.getElementById('ledger-table-body');
            let totalPay = 0, totalPaid = 0, totalBal = 0;

            tbody.innerHTML = sts.map(s => {
                const studentRecords = ledger.filter(l => l.studentId === s.id);
                const payable = studentRecords.reduce((sum, r) => sum + r.payable, 0);
                const paid = studentRecords.reduce((sum, r) => sum + (r.paid || 0), 0);
                const balance = payable - paid;
                totalPay += payable; totalPaid += paid; totalBal += balance;

                return `
                    <tr class="hover:bg-slate-50">
                        <td class="px-6 py-4 font-bold">${s.name}</td>
                        <td class="px-6 py-4 text-slate-500">${s.fatherName}</td>
                        <td class="px-6 py-4 text-xs font-bold uppercase">${s.class}</td>
                        <td class="px-6 py-4">Rs ${payable}</td>
                        <td class="px-6 py-4">Rs ${paid}</td>
                        <td class="px-6 py-4 ${balance > 0 ? 'text-rose-600 font-bold' : 'text-emerald-600 font-bold'}">Rs ${balance}</td>
                        <td class="px-6 py-4 text-center">
                            ${balance > 0 ? `<button onclick="redirectToPay('${s.id}')" class="bg-rose-600 text-white px-4 py-1.5 rounded-full text-[10px] font-black uppercase">Pay Now</button>` : `<span class="bg-emerald-50 text-emerald-600 px-4 py-1.5 rounded-full text-[10px] font-black uppercase">Cleared</span>`}
                        </td>
                    </tr>
                `;
            }).join('');

            document.getElementById('total-payable-sum').innerText = "Rs " + totalPay;
            document.getElementById('total-paid-sum').innerText = "Rs " + totalPaid;
            document.getElementById('total-balance-sum').innerText = "Rs " + totalBal;
        }

        function redirectToPay(id) {
            switchTab('payment');
            document.getElementById('pay-student-id').value = id;
            handleStudentSelect();
        }

        function initPaymentForm() {
            const select = document.getElementById('pay-student-id');
            const ledger = DB.getLedger();
            
            const studentsWithDues = DB.getStudents().filter(s => {
                const bal = ledger.filter(l => l.studentId === s.id).reduce((sum, r) => sum + (r.balance || 0), 0);
                return bal > 0;
            });

            select.innerHTML = '<option value="">Select Student Profile...</option>' + 
                studentsWithDues.map(s => `<option value="${s.id}">${s.name} (${s.class})</option>`).join('');
            
            document.getElementById('payment-details-box').classList.add('hidden');
        }

        function handleStudentSelect() {
            const id = document.getElementById('pay-student-id').value;
            if(!id) return;
            const records = DB.getLedger().filter(l => l.studentId === id);
            const totalDue = records.reduce((sum, r) => sum + (r.balance || 0), 0);
            document.getElementById('pay-outstanding').innerText = "Rs " + totalDue;
            document.getElementById('pay-amount').value = totalDue;
            document.getElementById('pay-month').value = new Date().toISOString().slice(0, 7);
            document.getElementById('payment-details-box').classList.remove('hidden');
        }

        document.getElementById('payment-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const id = document.getElementById('pay-student-id').value;
            const amt = parseFloat(document.getElementById('pay-amount').value);
            const month = document.getElementById('pay-month').value;
            const ledger = DB.getLedger();
            const studentRecords = ledger.filter(l => l.studentId === id).sort((a,b) => a.month.localeCompare(b.month));
            const totalDue = studentRecords.reduce((sum, r) => sum + (r.balance || 0), 0);

            if(amt > totalDue) return showToast("Amount exceeds total dues!");

            let remaining = amt;
            studentRecords.forEach(rec => {
                if(remaining <= 0) return;
                const deduct = Math.min(remaining, rec.balance);
                rec.paid = (rec.paid || 0) + deduct; 
                rec.balance = (rec.balance || 0) - deduct; 
                remaining -= deduct;
            });

            localStorage.setItem('ss_ledger', JSON.stringify(ledger));
            const txs = DB.getTransactions();
            txs.push({ id: Date.now(), studentId: id, amount: amt, month: month, date: new Date().toLocaleDateString(), timestamp: new Date().getTime() });
            localStorage.setItem('ss_transactions', JSON.stringify(txs));

            prepareReceipt(id, amt, month);
            DB.updateUI();
        });

        function prepareReceipt(id, amt, month) {
            const st = DB.getStudents().find(s => s.id === id);
            const settings = DB.getSettings();
            const ledger = DB.getLedger().filter(l => l.studentId === id);
            const totalPayable = ledger.reduce((sum, r) => sum + r.payable, 0);
            const totalBalance = ledger.reduce((sum, r) => sum + (r.balance || 0), 0);

            document.querySelectorAll('.r-school-name').forEach(el => el.innerText = settings.name);
            document.querySelectorAll('.r-school-address').forEach(el => el.innerText = `${settings.address} | ${settings.contact}`);
            document.querySelectorAll('.r-date').forEach(el => el.innerText = new Date().toLocaleDateString());
            document.querySelectorAll('.r-name').forEach(el => el.innerText = st.name);
            document.querySelectorAll('.r-father').forEach(el => el.innerText = st.fatherName);
            document.querySelectorAll('.r-class').forEach(el => el.innerText = st.class);
            document.querySelectorAll('.r-month').forEach(el => el.innerText = month);
            document.querySelectorAll('.r-payable').forEach(el => el.innerText = "Rs " + totalPayable);
            document.querySelectorAll('.r-paid').forEach(el => el.innerText = "Rs " + amt);
            document.querySelectorAll('.r-bal').forEach(el => el.innerText = "Rs " + totalBalance);

            document.querySelectorAll('.r-logo').forEach(el => {
                if(settings.logo) { el.src = settings.logo; el.closest('.r-logo-wrap').classList.remove('hidden'); }
                else el.closest('.r-logo-wrap').classList.add('hidden');
            });

            document.getElementById('receipt-container').classList.remove('hidden');
            setTimeout(() => { window.print(); showToast("Receipt Generated"); }, 500);
        }

        function renderReports() {
            const filter = document.getElementById('report-class-filter').value;
            const sts = DB.getStudents();
            const ledger = DB.getLedger();
            const tbody = document.getElementById('report-table-body');
            let total = 0;

            tbody.innerHTML = sts.filter(s => !filter || s.class === filter).map(s => {
                const bal = ledger.filter(l => l.studentId === s.id).reduce((sum, r) => sum + (r.balance || 0), 0);
                if(bal <= 0) return '';
                total += bal;
                return `<tr><td class="px-6 py-4 font-bold">${s.name}</td><td class="px-6 py-4 text-slate-500">${s.fatherName}</td><td class="px-6 py-4">${s.class}</td><td class="px-6 py-4 text-rose-600 font-bold">Rs ${bal}</td></tr>`;
            }).join('');

            document.getElementById('report-total-sum').innerText = "Rs " + total;
        }

        function exportToPDF() {
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                const settings = DB.getSettings();
                const filter = document.getElementById('report-class-filter').value || 'All Classes';

                doc.setFontSize(22);
                doc.setTextColor(30, 64, 175);
                doc.text(settings.name, 105, 20, { align: 'center' });
                
                doc.setFontSize(10);
                doc.setTextColor(100, 116, 139);
                doc.text(settings.address, 105, 27, { align: 'center' });
                
                doc.setDrawColor(200);
                doc.line(20, 32, 190, 32);
                
                doc.setFontSize(14);
                doc.setTextColor(0);
                doc.text(`Defaulters Report - ${filter}`, 20, 42);

                doc.autoTable({
                    html: '#report-table',
                    startY: 50,
                    theme: 'grid',
                    headStyles: { fillColor: [30, 41, 59] },
                    footStyles: { fillColor: [241, 245, 249], textColor: [225, 29, 72] }
                });

                doc.save(`Defaulters_${filter}_${new Date().toLocaleDateString()}.pdf`);
                showToast("PDF Saved");
            } catch (err) {
                console.error(err);
                showToast("PDF Generation Failed!");
            }
        }

        function applySettings() {
            const s = DB.getSettings();
            document.getElementById('sidebar-school-name').innerText = s.name;
            document.getElementById('set-school-name').value = s.name;
            document.getElementById('set-address').value = s.address;
            document.getElementById('set-contact').value = s.contact;
            if(s.logo) {
                document.getElementById('sidebar-logo').innerHTML = `<img src="${s.logo}" class="w-full h-full object-cover">`;
                document.getElementById('logo-preview').innerHTML = `<img src="${s.logo}" class="w-full h-full object-contain">`;
            }
        }

        function handleLogoUpload(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('logo-preview').innerHTML = `<img src="${e.target.result}" class="w-full h-full object-contain">`;
                    localStorage.setItem('ss_temp_logo', e.target.result);
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        function saveSettings() {
            const temp = localStorage.getItem('ss_temp_logo');
            const s = {
                name: document.getElementById('set-school-name').value,
                address: document.getElementById('set-address').value,
                contact: document.getElementById('set-contact').value,
                logo: temp || DB.getSettings().logo
            };
            localStorage.setItem('ss_settings', JSON.stringify(s));
            localStorage.removeItem('ss_temp_logo');
            DB.updateUI();
            showToast("Settings Saved");
        }

        function renderDashboard() {
            const sts = DB.getStudents();
            const ledger = DB.getLedger();
            
            // Statistics logic fix - using ledger aggregate for accuracy
            const totalPayable = ledger.reduce((sum, l) => sum + (l.payable || 0), 0);
            const totalCollected = ledger.reduce((sum, l) => sum + (l.paid || 0), 0);
            const totalDues = ledger.reduce((sum, l) => sum + (l.balance || 0), 0);

            document.getElementById('dash-total-students').innerText = sts.length;
            document.getElementById('dash-total-collected').innerText = "Rs " + totalCollected.toLocaleString();
            document.getElementById('dash-total-dues').innerText = "Rs " + totalDues.toLocaleString();
            document.getElementById('dash-total-receivable').innerText = "Rs " + totalPayable.toLocaleString();

            renderSixMonthAnalysis();
        }

        function renderSixMonthAnalysis() {
            const txs = DB.getTransactions();
            const analysisList = document.getElementById('monthly-analysis-list');
            analysisList.innerHTML = '';
            
            const months = [];
            for(let i=0; i<6; i++) {
                const d = new Date();
                d.setMonth(d.getMonth() - i);
                months.push(d.toISOString().slice(0, 7));
            }

            months.forEach(m => {
                const monthName = new Date(m).toLocaleString('default', { month: 'long', year: 'numeric' });
                const monthCollection = txs.filter(t => t.month === m).reduce((sum, t) => sum + t.amount, 0);
                
                analysisList.innerHTML += `
                    <div class="flex justify-between items-center p-3 border-b border-slate-50 last:border-0 hover:bg-slate-50 rounded-xl transition-colors">
                        <div>
                            <p class="font-bold text-slate-700">${monthName}</p>
                            <p class="text-[10px] text-slate-400 uppercase tracking-widest">Monthly Collection</p>
                        </div>
                        <div class="text-right">
                            <p class="font-black text-emerald-600">Rs ${monthCollection.toLocaleString()}</p>
                            <div class="w-24 bg-slate-100 h-1.5 rounded-full mt-1 overflow-hidden">
                                <div class="bg-emerald-500 h-full" style="width: ${Math.min((monthCollection/50000)*100, 100)}%"></div>
                            </div>
                        </div>
                    </div>
                `;
            });
        }

        window.onload = () => { DB.init(); DB.updateUI(); switchTab('dashboard'); };

        document.getElementById('student-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const success = DB.saveStudent({
                id: document.getElementById('edit-id').value || null,
                name: document.getElementById('st-name').value,
                fatherName: document.getElementById('st-father').value,
                class: document.getElementById('st-class').value,
                fee: document.getElementById('st-fee').value
            });
            if(success) { toggleModal('student-modal'); showToast("Saved"); }
        });
    </script>
</body>
</html>
